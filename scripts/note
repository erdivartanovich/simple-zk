#!/usr/bin/env sh

ZK_NOTEBOOK_DIR="/home/rdi/Cabin/org/zettels"
FLEETING_DIR="$ZK_NOTEBOOK_DIR/inbox"
PERMANENT_DIR="$ZK_NOTEBOOK_DIR/permanent"

print_header() {
    subtitle=${1:-"What's up"}
    gum style \
	    --foreground 228 --border-foreground 228 --border rounded \
	    --align center --width 67 --margin "1 2" --padding "1 1" \
	    "Quick note" "$subtitle"
}

print_guidance() {
    case $1 in
        "permanent-idea")
            gum style --foreground 215 "ðŸ’¡ Permanent Idea Note: Your original thoughts and insights"
            gum style --foreground 215 "   Will include 'Related Ideas' section for connections"
            ;;
        "permanent-source")
            gum style --foreground 207 "ðŸ“š Permanent Literature Note: Knowledge from external sources"
            gum style --foreground 207 "   Will include 'Parent/Children' sections for hierarchy"
            ;;
        "source")
            gum style --foreground 207 "ðŸ“– Fleeting Literature Note: Quick source capture"
            gum style --foreground 207 "   Will be tagged as #source for later review"
            ;;
        "idea")
            gum style --foreground 215 "ðŸ’­ Fleeting Idea Note: Quick thought capture"
            gum style --foreground 215 "   Will be tagged as #idea for later review"
            ;;
    esac
}

# Get note type first
note_type=$(gum choose "source" "idea" "permanent-source" "permanent-idea") || exit 1

# Set target directory and metadata based on type
case $note_type in
    "permanent-idea")
        TARGET_DIR="$PERMANENT_DIR"
        TEMPLATE="permanent.md"
        MAIN_TAG="idea"
        ;;
    "permanent-source")
        TARGET_DIR="$PERMANENT_DIR"
        TEMPLATE="permanent.md"
        MAIN_TAG="source"
        ;;
    "idea")
        TARGET_DIR="$FLEETING_DIR"
        TEMPLATE="fleeting.md"
        MAIN_TAG="idea"
        NOTE_HINT="idea"
        ;;
    "source")
        TARGET_DIR="$FLEETING_DIR"
        TEMPLATE="fleeting.md"
        MAIN_TAG="source"
        NOTE_HINT="source"
        ;;
esac

print_guidance "$note_type"

# Collect title
if [ $# -gt 0 ]; then
    title="$*"
    print_header "$title"
else
    print_header "Create $note_type note"
    while true; do
        title=$(gum input --placeholder "Note Title") || exit 1
        [ -n "$title" ] && break
    done
fi

# Collect extra metadata
extra_args=""

# Add main tag for permanent notes or hint for fleeting notes
if [ -n "$MAIN_TAG" ]; then
    extra_args="--extra main_tag=$MAIN_TAG"
fi

# Add boolean flags for template conditionals
if [[ $note_type == "permanent-source" ]]; then
    extra_args="$extra_args --extra is_source=true"
elif [[ $note_type == "permanent-idea" ]]; then
    extra_args="$extra_args --extra is_source=false"
fi

# Collect source/author for source notes
if [[ $note_type == "permanent-source" ]] || [[ $note_type == "source" ]]; then
    note_source=$(gum input --placeholder "Source (taken from)") || ""
    note_author=$(gum input --placeholder "Author (if applicable)") || ""
    if [ -n "$note_source" ]; then
        extra_args="$extra_args --extra source=\"$note_source\""
    fi
    if [ -n "$note_author" ]; then
        extra_args="$extra_args --extra author=\"$note_author\""
    fi
fi

# Create the note
zk new -t "$title" --template "$TEMPLATE" $extra_args "$TARGET_DIR"
